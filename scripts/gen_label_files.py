import config
import sys
import os 
import shutil
import glob

# nested folder generated by prep_DM_HGR.py, with the following structure
# - folder
#   - species 1
#       - species 1 file 1
#   - species 2
#       - species 2 file 1
#       - species 2 file 2

# # for Task 1 provided
# src = 'HGR_species_folder' 
# dest = 'HGR_species'
# label_dir = 'file2label/'
# data_path = config.DM_data_path

# for Task 2
src = 'GTDB_subset_representative_folder' 
dest = 'GTDB_subset_representative'
label_dir = 'file2label/'
name_dir = 'name2label/'
data_path = config.MLDSP_data_path


DM_path = config.DM_path

# make dest folder
if not os.path.exists(os.path.join(data_path, dest)):
    os.mkdir(os.path.join(data_path, dest))

# concatenate all files in subdir to _combined.fna
for subdir in os.listdir(os.path.join(data_path, src)):
    if len(os.listdir(os.path.join(data_path, src, subdir))) != 0: # the folder is not empty
        with open(os.path.join(data_path, dest, "label_"+subdir+".fa"), 'wb') as outfile:
            for filename in \
                (glob.glob(data_path+"/"+src+'/'+subdir+'/*.fa')+ \
                    glob.glob(data_path+"/"+src+'/'+subdir+'/*.fna') + \
                        glob.glob(data_path+"/"+src+'/'+subdir+'/*.fasta')):
                with open(filename, 'rb') as readfile:
                    shutil.copyfileobj(readfile, outfile)

# generate label_{dir}.txt
label_id = 0
with open(os.path.join(DM_path,label_dir, dest+".txt"), 'w') as f:
    for fna_file in os.listdir(os.path.join(data_path, dest)):
        f.write(fna_file+"\t"+str(label_id)+"\n")
        label_id += 1

# generate name2label_{dir}.txt
label_id=0
with open(os.path.join(DM_path, "name2label", dest+".txt"), "w") as f:
    for fna_file in os.listdir(os.path.join(data_path, dest)):
        if fna_file.endswith('.fa'):
            cur_class = fna_file[:-3]
        elif fna_file.endswith('.fna'):
            cur_class = fna_file[:-4]
        elif fna_file.endswith('.fasta'):
            cur_class = fna_file[:-6]
        f.write(cur_class+"\t"+str(label_id)+"\n")
        label_id += 1
